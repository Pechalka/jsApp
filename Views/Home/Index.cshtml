@{
    Layout = null;
}

<!DOCTYPE html>

@helper GetTemplate(string templateId)
{
    @Html.Action("GetTemplate", "Templates", new { templateId })
}

<html>
<head>
    <title>Index</title>
   
    @GetTemplate("_baseLayout")
    @GetTemplate("_catalogLayout")
     
    @GetTemplate("dashbord")
    @GetTemplate("templateList")
    @GetTemplate("templateEdit")
    @GetTemplate("mediaboxsetup")
    
    @GetTemplate("test")
       @GetTemplate("statichtml")

    <style type="text/css">
        .active {
            background-color: red;
        }
    </style>
    <script src="@Url.Content("~/Scripts/jquery-1.8.2.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/knockout-2.1.0.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/sammy/sammy.min.js")" type="text/javascript"></script>
    <script type="text/javascript">
        //todo:
        // refactoring  start method
        // lazy loading for templates
        // static html +

        var app = $.sammy(function () {
            var self = this;

            self.screens = [];
            self.RegisterScreen = function (screen) {
                self.screens.push(screen);
            };

            self.content = ko.observable(null);

            self.initWithoutRequest = function (screen) {
                var screenData = {};
                if (screen.viewModel)
                    $.extend(screenData, new screen.viewModel(null, null));

                if (!screen.layout) {
                    return {
                        templateName: screen.template,
                        data: screenData
                    };
                } else {
                    var layoutData = {// have content field any way, for bind screen
                        content: ko.observable({
                            templateName: screen.template,
                            data: screenData
                        })
                    };
                    if (layout.viewModel)//if layout have viewModel exteden it
                        $.extend(layoutData, new layout.viewModel(null));

                    return {
                        templateName: layout.template,
                        data: layoutData
                    };
                }
            };

            self.initWithRequest = function (screen, responseData) {
                var screenData = responseData; // base view model is data from request
                
                if (!screen.layout) {
                    if (screen.viewModel)
                        $.extend(screenData, new screen.viewModel(responseData, null)); //if have custom viewmodel extend, layout is null

                    return {
                        templateName: screen.template,
                        data: screenData
                    };
                } else {

                    var layout = screen.layout,
                        layoutData = layout.viewModel ? new layout.viewModel(responseData) : {};

                    if (screen.viewModel)
                        $.extend(screenData, new screen.viewModel(responseData, layoutData)); //if have custom viewmodel extend, layout is null

                    layoutData.content = ko.observable({
                        templateName: screen.template,
                        data: screenData
                    });

                    return {
                        templateName: layout.template,
                        data: layoutData
                    };
                }
            };

            self.start = function () {

                var roters = [];
                $.map(self.screens, function (screen) {
                    var action = function () {
                        if (screen.dataUrl) {
                            $.get(screen.dataUrl, this.params.toHash(), function (responseData) {
                                var page = self.initWithRequest(screen, responseData);
                                self.content(page);
                            });
                        } else {
                            var page = self.initWithoutRequest(screen);
                            self.content(page);    
                        }
                    };
                    roters.push(['get', screen.hash, action]);
                });

                self.mapRoutes(roters);
                self.run();
                ko.applyBindings(self);
            };


        });

        var Layout = function (templateName, viewModel) {
            this.template = templateName;
            this.viewModel = viewModel;
        };

        $(function () {
            var BaseLayout = new Layout('_baseLayout');
            var CatalogLayout = new Layout('_catalogLayout', function () {
                var self = this;
                self.catalogMenu = ko.observableArray([]);
                self.selectedItem = ko.observable('#templates');
                $.get('@Url.Action("GetMenu")', '', function (data) {
                    self.catalogMenu(data.items);
                });
            });

            app.RegisterScreen({
                dataUrl: '@Url.Action("GetMenu")',
                hash: '/?',
                layout: BaseLayout,
                template: "dashbord"
            });
            app.RegisterScreen({
                dataUrl: '@Url.Action("GetTemplatets")',
                hash: '/?#templates',
                layout: CatalogLayout,
                template: "templateList",
                viewModel: function (data, layout) {
                    var self = this;
                    layout.selectedItem('#templates');
                    self.goToEdit = function (item) {
                        location.hash = '#templates/' + item.Id;
                    };
                }
            });
            app.RegisterScreen({
                dataUrl: '@Url.Action("GetTemplate")',
                hash: '/?#templates/:id',
                layout: CatalogLayout,
                template: "templateEdit",
                viewModel: function (data, layout) {
                    layout.selectedItem('#templates');
                }
            });

            app.RegisterScreen({
                dataUrl: '@Url.Action("GettestData")',
                hash: '/?#test',
                template: "test"
            });

            app.RegisterScreen({
                dataUrl: '@Url.Action("GetMediaBoxData")',
                hash: '/?#mediaboxsetup',
                layout: CatalogLayout,
                template: "mediaboxsetup",
                viewModel: function (data, layout) {
                    layout.selectedItem('#mediaboxsetup');
                }
            });

            app.RegisterScreen({
                hash: '/?#staticHtml',
                template: "statichtml",
                viewModel: function () { 
                    this.age = 12;
                }
            });

            app.start();

            
        });
    </script>
</head>
<body>
<!-- ko with : content -->
    <!-- ko template: { name: templateName, data: data } -->
    <!-- /ko -->
<!-- /ko -->
</body>
</html>
